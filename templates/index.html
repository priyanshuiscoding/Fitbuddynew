{% extends "base.html" %}
{% block body %}
<div class="app">
  <header class="header">
    <h1 class="logo">FitBuddy</h1>
    <p class="tagline">Your chill best friend for last-minute outfit decisions</p>
  </header>

  <section class="section">
    <div class="section-head">
      <span class="icon pink">Step 1</span>
      <span class="title">Start with wardrobe</span>
    </div>
    <p class="question">Who am I dressing today?</p>
    <div class="radio-group">
      <div class="radio-option">
        <input type="radio" name="gender" id="g-men" value="Men" checked />
        <label for="g-men">Men</label>
      </div>
      <div class="radio-option">
        <input type="radio" name="gender" id="g-women" value="Women" />
        <label for="g-women">Women</label>
      </div>
    </div>
  </section>

  <section class="section">
    <button type="button" class="wardrobe-toggle" aria-expanded="false" data-wardrobe-toggle>
      View wardrobe status
    </button>
    <div class="card hidden" data-wardrobe-box aria-hidden="true">
      <div id="wardrobe-content"></div>
    </div>
    <button type="button" class="btn btn-secondary" id="btn-wardrobe-checked">
      I checked my wardrobe
    </button>
  </section>

  <section class="section hidden" id="planning-section">
    <div class="section-head">
      <span class="icon pink">Step 2</span>
      <span class="title">Choose the occasion</span>
    </div>
    <select class="occasion-select" id="occasion" aria-label="Occasion">
      <option value="Formal Meeting">Formal Meeting</option>
      <option value="Interview">Interview</option>
      <option value="Casual Outing">Casual Outing</option>
      <option value="Cafe / Movie">Cafe / Movie</option>
      <option value="Gym">Gym</option>
    </select>

    <p class="question" style="margin-top:0.75rem;">Step 3: choose recommendation mode</p>
    <div class="radio-group">
      <div class="radio-option">
        <input type="radio" name="preference-mode" id="mode-suggested" value="suggested" checked />
        <label for="mode-suggested">Show suggestions</label>
      </div>
      <div class="radio-option">
        <input type="radio" name="preference-mode" id="mode-custom" value="custom" />
        <label for="mode-custom">Use my outfit notes</label>
      </div>
    </div>

    <textarea
      id="outfit-input"
      class="outfit-input"
      rows="3"
      placeholder="Example: grey shirt and black trouser, brown shoes"
      aria-label="Outfit preference input"
      style="margin-top:0.75rem; display:none;"
    ></textarea>

    <p class="relax-line">Relax. I have got this.</p>
    <button type="button" class="btn btn-primary" id="btn-recommend">
      Show outfits
    </button>
  </section>

  <div id="outfit-zone" class="hidden">
    <section class="section">
      <div id="outfit-list"></div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary" id="btn-skip">Skip</button>
        <button type="button" class="btn btn-primary" id="btn-wear">Wear this</button>
      </div>
    </section>
  </div>

  <div id="final-zone" class="hidden">
    <section class="section">
      <div class="alert alert-success">You are set. Here is your outfit.</div>
      <div class="outfit-card final-outfit" id="final-outfit"></div>
    </section>
  </div>
</div>

<script>
(function() {
  const outfitZone = document.getElementById('outfit-zone');
  const outfitList = document.getElementById('outfit-list');
  const finalZone = document.getElementById('final-zone');
  const finalOutfit = document.getElementById('final-outfit');
  const btnRecommend = document.getElementById('btn-recommend');
  const btnSkip = document.getElementById('btn-skip');
  const btnWear = document.getElementById('btn-wear');
  const occasionSelect = document.getElementById('occasion');
  const outfitInput = document.getElementById('outfit-input');
  const wardrobeToggle = document.querySelector('[data-wardrobe-toggle]');
  const wardrobeBox = document.querySelector('[data-wardrobe-box]');
  const wardrobeContent = document.getElementById('wardrobe-content');
  const btnWardrobeChecked = document.getElementById('btn-wardrobe-checked');
  const planningSection = document.getElementById('planning-section');

  let outfits = [];
  let currentIndex = 0;
  let selectedOutfit = null;
  let wardrobeReviewed = false;

  function smoothScrollTo(el) {
    if (!el) return;
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function getGender() {
    return document.querySelector('input[name="gender"]:checked').value;
  }

  function getOccasion() {
    return occasionSelect.value;
  }

  function getPreferenceMode() {
    return document.querySelector('input[name="preference-mode"]:checked').value;
  }

  function updatePreferenceInputVisibility() {
    const isCustom = getPreferenceMode() === 'custom';
    outfitInput.style.display = isCustom ? 'block' : 'none';
    if (!isCustom) outfitInput.value = '';
  }

  async function loadWardrobe() {
    const gender = getGender();
    const r = await fetch(`/api/wardrobe/${encodeURIComponent(gender)}`);
    if (!r.ok) return;
    const data = await r.json();
    let html = '';
    for (const [cat, items] of Object.entries(data)) {
      if (cat === 'accessories') continue;
      html += `<p><strong>${cat}</strong><br>`;
      const list = Array.isArray(items) ? items : Object.values(items).flat();
      list.forEach(item => {
        const name = item.name || item;
        const status = item.status === 'available' ? 'Available' : 'Not available';
        html += `${status}: ${name}<br>`;
      });
      html += '</p>';
    }
    wardrobeContent.innerHTML = html || 'No items.';
  }

  wardrobeToggle.addEventListener('click', function() {
    const wasHidden = wardrobeBox.classList.contains('hidden');
    wardrobeBox.classList.toggle('hidden');
    this.setAttribute('aria-expanded', String(wasHidden));
    wardrobeBox.setAttribute('aria-hidden', String(!wasHidden));
    if (wasHidden && !wardrobeContent.innerHTML) loadWardrobe();
  });

  document.querySelectorAll('input[name="gender"]').forEach(el => {
    el.addEventListener('change', () => {
      wardrobeContent.innerHTML = '';
      wardrobeReviewed = false;
      planningSection.classList.add('hidden');
      outfitZone.classList.add('hidden');
      finalZone.classList.add('hidden');
    });
  });

  document.querySelectorAll('input[name="preference-mode"]').forEach(el => {
    el.addEventListener('change', updatePreferenceInputVisibility);
  });

  btnWardrobeChecked.addEventListener('click', function() {
    wardrobeReviewed = true;
    planningSection.classList.remove('hidden');
    outfitZone.classList.add('hidden');
    finalZone.classList.add('hidden');
    smoothScrollTo(planningSection);
  });

  function renderOutfit(outfit) {
    const top = outfit.top?.name || '';
    const bottom = outfit.bottom?.name || '';
    const shoes = outfit.shoes?.name || 'No matching shoes available';
    let levelUpHtml = '';
    if (outfit.accessories) {
      const style = outfit.top?.style;
      const names = [];
      Object.values(outfit.accessories).flat().forEach(a => {
        if (a.style === style) names.push(a.name);
      });
      if (names.length) {
        levelUpHtml = `
          <div class="level-up">
            <div class="level-up-head">
              You could level it up with:
            </div>
            <ul>
              <li>${names.join(', ')}</li>
            </ul>
          </div>
        `;
      }
    }
    return `
      <div class="outfit-card" data-outfit-index="${currentIndex}">
        <div class="outfit-head">
          <h3>How about this?</h3>
        </div>
        <div class="outfit-item"><strong>Top:</strong> ${top}</div>
        <div class="outfit-item"><strong>Bottom:</strong> ${bottom}</div>
        <div class="outfit-item"><strong>Shoes:</strong> ${shoes}</div>
        ${levelUpHtml}
        <div class="preview-wrap" id="preview-wrap" data-outfit-index="${currentIndex}">
          <button type="button" class="btn btn-secondary" style="margin-top:0.5rem" data-generate-image>Show preview image</button>
        </div>
        <div class="affiliate-wrap" id="affiliate-wrap" data-outfit-index="${currentIndex}">
          <div class="affiliate-head">
            Complete this look
          </div>
          <div class="affiliate-list" data-affiliate-list>
            <div class="affiliate-loading">Finding matching items to pair up...</div>
          </div>
          <div class="affiliate-note">Affiliate links shown for demo and monetization flow validation.</div>
        </div>
      </div>
    `;
  }

  function showOutfit() {
    if (selectedOutfit) {
      const o = selectedOutfit;
      finalOutfit.innerHTML = `
        <div class="outfit-item"><strong>Top:</strong> ${o.top?.name}</div>
        <div class="outfit-item"><strong>Bottom:</strong> ${o.bottom?.name}</div>
        <div class="outfit-item"><strong>Shoes:</strong> ${o.shoes?.name || '-'}</div>
      `;
      finalZone.classList.remove('hidden');
      outfitZone.classList.add('hidden');
      smoothScrollTo(finalZone);
      return;
    }
    if (currentIndex >= outfits.length) {
      outfitList.innerHTML = '<div class="alert alert-warning">No more outfits for this selection. Try another occasion or preference.</div>';
      outfitZone.classList.remove('hidden');
      smoothScrollTo(outfitZone);
      return;
    }

    outfitList.innerHTML = renderOutfit(outfits[currentIndex]);

    const wrap = document.getElementById('preview-wrap');
    const genBtn = document.querySelector('[data-generate-image]');
    const affiliateWrap = document.querySelector('[data-affiliate-list]');
    if (genBtn) {
      genBtn.addEventListener('click', function() {
        generateImage(currentIndex, wrap, genBtn);
      });
    }
    if (affiliateWrap) {
      loadAffiliateItems(currentIndex, affiliateWrap);
    }
    outfitZone.classList.remove('hidden');
    finalZone.classList.add('hidden');
    smoothScrollTo(outfitZone);
  }

  function renderAffiliateCards(items) {
    if (!items || items.length === 0) {
      return '<div class="alert alert-warning">No extra buy suggestions needed. Your wardrobe already covers this look.</div>';
    }
    return items.map(item => `
      <a class="affiliate-card" href="${item.affiliate_url}" target="_blank" rel="noopener noreferrer">
        <img src="${item.image_url}" alt="${item.title}" loading="lazy" />
        <div class="affiliate-card-body">
          <div class="affiliate-platform">${item.platform}</div>
          <div class="affiliate-title">${item.title}</div>
          <div class="affiliate-cta">View product</div>
        </div>
      </a>
    `).join('');
  }

  async function loadAffiliateItems(index, hostEl) {
    const outfit = outfits[index];
    if (!outfit) return;
    hostEl.innerHTML = '<div class="affiliate-loading">Finding matching items to pair up...</div>';
    try {
      const r = await fetch('/api/affiliate-items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          outfit,
          gender: getGender(),
          occasion: getOccasion()
        })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Failed to load affiliate items');
      hostEl.innerHTML = renderAffiliateCards(data.items || []);
    } catch (e) {
      hostEl.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
    }
  }

  async function generateImage(index, wrap, btn) {
    const outfit = outfits[index];
    if (!outfit) return;
    wrap.classList.add('loading');
    wrap.innerHTML = '';
    btn.disabled = true;
    try {
      const r = await fetch('/api/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ outfit, gender: getGender() })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Failed to generate image');
      const img = document.createElement('img');
      img.src = data.image;
      img.alt = 'Outfit preview';
      wrap.classList.remove('loading');
      wrap.innerHTML = '';
      wrap.appendChild(img);
    } catch (e) {
      wrap.classList.remove('loading');
      wrap.innerHTML = `<div class="alert alert-error">${e.message}</div><button type="button" class="btn btn-secondary" data-generate-image>Retry</button>`;
      wrap.querySelector('[data-generate-image]')?.addEventListener('click', () => generateImage(index, wrap, wrap.querySelector('[data-generate-image]')));
    }
    btn.disabled = false;
  }

  btnRecommend.addEventListener('click', async function() {
    if (!wardrobeReviewed) {
      outfitList.innerHTML = '<div class="alert alert-warning">Check wardrobe first, then continue to occasion and recommendations.</div>';
      outfitZone.classList.remove('hidden');
      finalZone.classList.add('hidden');
      smoothScrollTo(outfitZone);
      return;
    }

    const preferenceMode = getPreferenceMode();
    const userInput = (outfitInput.value || '').trim();
    if (preferenceMode === 'custom' && !userInput) {
      outfitList.innerHTML = '<div class="alert alert-warning">Enter your outfit notes, for example: grey shirt, black trouser, brown shoes.</div>';
      outfitZone.classList.remove('hidden');
      finalZone.classList.add('hidden');
      smoothScrollTo(outfitZone);
      return;
    }

    btnRecommend.disabled = true;
    try {
      const r = await fetch('/api/recommend', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          gender: getGender(),
          occasion: getOccasion(),
          user_input: preferenceMode === 'custom' ? userInput : ''
        })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Recommendation failed');
      outfits = data.outfits || [];
      currentIndex = 0;
      selectedOutfit = null;
      if (outfits.length === 0) {
        outfitList.innerHTML = '<div class="alert alert-warning">No matching outfit found in wardrobe for this request.</div>';
        outfitZone.classList.remove('hidden');
        finalZone.classList.add('hidden');
        smoothScrollTo(outfitZone);
      } else {
        showOutfit();
      }
    } catch (e) {
      outfitList.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
      outfitZone.classList.remove('hidden');
      finalZone.classList.add('hidden');
      smoothScrollTo(outfitZone);
    }
    btnRecommend.disabled = false;
  });

  btnSkip.addEventListener('click', function() {
    if (selectedOutfit) return;
    currentIndex++;
    showOutfit();
  });

  btnWear.addEventListener('click', function() {
    if (currentIndex >= outfits.length) return;
    selectedOutfit = outfits[currentIndex];
    showOutfit();
  });

  updatePreferenceInputVisibility();
})();
</script>
{% endblock %}
